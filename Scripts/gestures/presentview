#!/bin/bash

TOGGLE=$HOME/Scripts/gestures/currentlyup
DOWNID=$HOME/Scripts/gestures/downid

case $1 in
  --up )
    expose(){
      xdotool key ctrl+F9
      touch $TOGGLE
      MOUSE_ID=$(xinput --list | grep -i -m 1 'TM3' | grep -o 'id=[0-9]\+' | grep -o '[0-9]\+')
      {
        trap 'rm $TOGGLE; exit' SIGINT
        if on_ac_power; then
          time=0.02
        else
          time=0.11
        fi
        while true; do
        STATE1=$(xinput --query-state $MOUSE_ID)
        if [[ $STATE1 == *"button[1]=down"* ]]; then
          rm $TOGGLE
          break
        fi
        sleep $time
        done
      } &
    }
    if [[ -e $DOWNID ]]; then
      xdotool windowactivate "$(xdotool search --pid "$(cat $DOWNID)" | tail -1)" && rm $DOWNID || expose
    elif [[ ! -e $TOGGLE ]]; then
      expose
    fi
  ;;
  --down )
    if [[ -e $TOGGLE ]]; then
      pkill -SIGINT -f "presentview --up"
      xdotool key ctrl+F9
    else
      echo "$(xdotool getwindowpid $(xdotool getwindowfocus))" > $DOWNID
      xdotool key super+s
      { sleep .6; rm $DOWNID 2>/dev/null; } &
    fi
  ;;
esac
